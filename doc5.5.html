<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doc Interpret | Gestão Inteligente de Exames</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-font-smoothing: antialiased; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.6); transition: all 0.4s ease; }
        .glass-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05); }
        #toast-container { position: fixed; top: 24px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 16px 24px; border-radius: 18px; background: #fff; box-shadow: 0 10px 15px rgba(0,0,0,0.1); opacity: 0; transition: all 0.4s; }
        .toast.show { opacity: 1; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .switch-toggle { position: relative; width: 240px; height: 48px; background: #e2e8f0; border-radius: 24px; padding: 4px; display: flex; align-items: center; cursor: pointer; }
        .switch-toggle .slider { position: absolute; width: 114px; height: 40px; background: white; border-radius: 20px; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .switch-toggle.mensal .slider { transform: translateX(118px); }
        .switch-toggle span { position: relative; flex: 1; text-align: center; font-size: 11px; font-weight: 700; z-index: 1; color: #64748b; }
        .hidden-scale { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal { transition: all 0.3s; }
        .shimmer { background: linear-gradient(90deg, #f1f5f9 25%, #f8fafc 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4 bg-slate-50">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-md text-center">
            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white text-2xl font-black mx-auto mb-4">D</div>
            <h2 id="auth-title" class="text-2xl font-extrabold mb-6">Doc Interpret</h2>
            <div id="login-form" class="space-y-4 text-left">
                <input type="email" id="email" class="w-full p-4 bg-slate-50 border rounded-xl" placeholder="E-mail">
                <input type="password" id="password" class="w-full p-4 bg-slate-50 border rounded-xl" placeholder="Senha">
                <button onclick="handleAuth()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold">Entrar</button>
                <p class="text-xs text-blue-600 text-center cursor-pointer font-bold" onclick="toggleAuthMode()" id="toggle-text">Criar nova conta</p>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen">
        <nav class="glass sticky top-0 z-40 px-6 py-4 flex justify-between items-center">
            <button onclick="toggleProfileMenu()" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <span class="font-black text-xl">Doc Interpret</span>
            <div id="profile-menu" class="hidden-scale absolute top-20 left-6 w-64 bg-white rounded-2xl shadow-2xl p-4 z-50">
                <p id="user-display-name" class="text-sm font-bold mb-4 border-b pb-2"></p>
                <button onclick="openPlansModal()" class="w-full text-left p-2 hover:bg-slate-50 rounded-lg text-xs font-bold">PLANOS E UPGRADE</button>
                <button onclick="logout()" class="w-full text-left p-2 hover:bg-red-50 text-red-500 rounded-lg text-xs font-bold">SAIR</button>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto p-6">
            <div class="flex justify-between items-center mb-10">
                <h1 class="text-3xl font-black">Meus exames</h1>
                <button onclick="openModal('upload-modal')" class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold text-xs uppercase">Novo Exame</button>
            </div>
            <div id="doc-list" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </main>
    </div>

    <div id="plans-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md" onclick="closeModal('plans-modal')"></div>
        <div class="bg-white w-full max-w-5xl rounded-[3rem] p-10 shadow-2xl relative z-10 overflow-y-auto max-h-[90vh]">
            <div class="text-center mb-10">
                <h3 class="text-3xl font-black mb-2">Evolua sua saúde</h3>
                <div class="flex justify-center mt-6">
                    <div id="period-selector" class="switch-toggle" onclick="toggleBilling()">
                        <div class="slider"></div>
                        <span id="label-anual" class="active">Anual</span>
                        <span id="label-mensal">Mensal</span>
                    </div>
                </div>
            </div>

            <div id="checkout-container" class="hidden bg-slate-50 p-6 rounded-2xl border mb-10">
                <div id="checkout-element"></div>
                <button onclick="cancelCheckout()" class="w-full mt-4 text-[10px] font-bold text-slate-400 uppercase">Cancelar e voltar</button>
            </div>

            <div id="plans-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="border p-8 rounded-3xl bg-slate-50">
                    <h4 class="font-bold">Iniciante</h4>
                    <p class="text-2xl font-black my-4">Grátis</p>
                    <button id="btn-plan-0" class="w-full p-4 rounded-xl bg-slate-200 text-slate-500 text-xs font-bold" disabled>Atual</button>
                </div>
                <div class="border-2 border-blue-500 p-8 rounded-3xl bg-blue-50 relative">
                    <h4 class="font-bold text-blue-600">Essencial</h4>
                    <p class="text-4xl font-black my-4" id="price-basic">R$ 29</p>
                    <button onclick="handleSubscription(1)" id="btn-plan-1" class="w-full p-4 rounded-xl bg-blue-600 text-white text-xs font-bold">Assinar</button>
                </div>
                <div class="border p-8 rounded-3xl bg-slate-900 text-white">
                    <h4 class="font-bold">Ilimitado</h4>
                    <p class="text-4xl font-black my-4" id="price-pro">R$ 59</p>
                    <button onclick="handleSubscription(2)" id="btn-plan-2" class="w-full p-4 rounded-xl bg-white text-slate-900 text-xs font-bold">Assinar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="upload-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/20" onclick="closeModal('upload-modal')"></div>
        <div class="bg-white w-full max-w-md rounded-3xl p-8 relative z-10">
            <h3 class="font-black text-xl mb-6">Novo Laudo</h3>
            <input type="text" id="new-doc-name" class="w-full p-4 border rounded-xl mb-4" placeholder="Nome do exame">
            <input type="file" id="file-input" multiple class="mb-4 text-xs">
            <button onclick="processDocument()" id="start-ia-btn" class="w-full bg-slate-900 text-white p-4 rounded-xl font-bold">Analisar com IA</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://doc-interpret-926187447831.europe-west1.run.app';
        const STRIPE_PK = 'pk_test_51SwTKe9JbbIHrSR1EC127ttxDqR0HBkTNR0wuTxWolqvIS3eadY4rPHPfRMi1A4JZHePfgxVoElKS0Iy2yx8hX1200LiqJrUKw';
        
        let token = localStorage.getItem('token');
        let stripe = null;
        let checkout = null;
        let currentBilling = 'anual';
        let isLogin = true;

        // --- INICIALIZAÇÃO STRIPE ---
        if (window.Stripe) {
            stripe = Stripe(STRIPE_PK);
        }

        function notify(msg, type='info') {
            const t = document.createElement('div');
            t.className = `toast show font-bold text-xs ${type === 'error' ? 'text-red-500' : 'text-green-600'}`;
            t.innerText = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // --- PAGAMENTO (CORREÇÃO DO CUSTOMER ID) ---
        async function handleSubscription(planId) {
            try {
                notify('Gerando sessão de pagamento...', 'info');
                const interval = currentBilling === 'anual' ? 'year' : 'month';

                const res = await fetch(`${API_URL}/api/subscription/subscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ plan: planId, interval: interval })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erro ao iniciar');

                // Se o backend retornou o clientSecret, montamos o checkout
                if (data.clientSecret) {
                    document.getElementById('plans-grid').classList.add('hidden');
                    document.getElementById('checkout-container').classList.remove('hidden');
                    
                    checkout = await stripe.initEmbeddedCheckout({
                        clientSecret: data.clientSecret,
                    });
                    checkout.mount('#checkout-element');
                }
            } catch (err) {
                notify(err.message, 'error');
            }
        }

        function cancelCheckout() {
            if (checkout) checkout.destroy();
            document.getElementById('checkout-container').classList.add('hidden');
            document.getElementById('plans-grid').classList.remove('hidden');
        }

        // --- AUTH ---
        function toggleAuthMode() {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? 'Doc Interpret' : 'Criar Conta';
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const endpoint = isLogin ? '/api/auth/login' : '/api/auth/register';
            
            const res = await fetch(`${API_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (res.ok) {
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    token = data.token;
                    location.reload();
                } else {
                    notify('Conta criada! Faça login.', 'success');
                    isLogin = true; toggleAuthMode();
                }
            } else notify(data.error, 'error');
        }

        // --- DASHBOARD ---
        if (token) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadDocuments();
        }

        async function loadDocuments() {
            const res = await fetch(`${API_URL}/api/documents`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            document.getElementById('doc-list').innerHTML = data.documentos?.map(d => `
                <div class="glass-card p-6 rounded-3xl">
                    <h3 class="font-bold">${d.nome}</h3>
                    <p class="text-[10px] text-slate-400 mb-4">${new Date(d.created_at).toLocaleDateString()}</p>
                    <button class="w-full bg-slate-900 text-white p-3 rounded-xl text-[10px] font-bold">VER RELATÓRIO</button>
                </div>
            `).join('') || 'Nenhum exame.';
        }

        function toggleBilling() {
            currentBilling = currentBilling === 'anual' ? 'mensal' : 'anual';
            document.getElementById('period-selector').classList.toggle('mensal');
            document.getElementById('price-basic').innerText = currentBilling === 'anual' ? 'R$ 29' : 'R$ 39';
        }

        function openModal(id) { document.getElementById(id).classList.remove('opacity-0', 'pointer-events-none'); }
        function closeModal(id) { document.getElementById(id).classList.add('opacity-0', 'pointer-events-none'); }
        function toggleProfileMenu() { document.getElementById('profile-menu').classList.toggle('hidden-scale'); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>