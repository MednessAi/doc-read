<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Doc Interpret | Gestão Inteligente de Exames</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b; 
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent; 
        }
        
        .glass { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(16px) saturate(180%); 
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5); 
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.6);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }

        #toast-container { position: fixed; top: 24px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 8px; }
        .toast { 
            pointer-events: auto; min-width: 320px; padding: 16px 24px; border-radius: 18px; 
            background: #fff; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            display: flex; align-items: center; justify-content: center; 
            opacity: 0; transform: translateY(-20px) scale(0.95); 
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            font-size: 14px; font-weight: 600;
        }
        .toast.show { opacity: 1; transform: translateY(0) scale(1); }
        .toast-success { color: #059669; border-left: 6px solid #10b981; }
        .toast-error { color: #dc2626; border-left: 6px solid #ef4444; }

        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid var(--primary);
            border-radius: 50%; width: 18px; height: 18px; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #camera-wrapper { border-radius: 32px; overflow: hidden; background: #000; position: relative; aspect-ratio: 3/4; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        #camera-video { width: 100%; height: 100%; object-fit: cover; }
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 12px; }
        .preview-item { position: relative; aspect-ratio: 1; border-radius: 16px; overflow: hidden; border: 2px solid #f1f5f9; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-img { position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; }

        #analysis-content { line-height: 1.7; color: #475569; }
        #analysis-content h1, #analysis-content h2 { font-weight: 800; color: #0f172a; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        #analysis-content strong { color: #1d4ed8; background: #eff6ff; padding: 2px 4px; border-radius: 4px; }
        #analysis-content ul { list-style: disc; padding-left: 1.25rem; margin-bottom: 1rem; }

        .switch-toggle { 
            position: relative; width: 240px; height: 48px; background: #e2e8f0; 
            border-radius: 24px; padding: 4px; display: flex; align-items: center; cursor: pointer; 
        }
        .switch-toggle .slider { 
            position: absolute; width: 114px; height: 40px; background: white; 
            border-radius: 20px; transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        .switch-toggle.mensal .slider { transform: translateX(118px); }
        .switch-toggle span { position: relative; flex: 1; text-align: center; font-size: 11px; font-weight: 700; text-transform: uppercase; z-index: 1; color: #64748b; transition: color 0.3s; }
        .switch-toggle span.active { color: #1e293b; }

        .hidden-scale { opacity: 0; transform: scale(0.95) translateY(-10px); pointer-events: none; }
        .modal { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #f8fafc 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4 bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-blue-50 via-white to-slate-50">
        <div class="bg-white p-8 md:p-10 rounded-[2rem] shadow-2xl w-full max-w-md border border-slate-100 text-center">
            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white text-2xl font-black mx-auto mb-4 shadow-lg shadow-blue-100">D</div>
            <h2 id="auth-title" class="text-2xl font-extrabold text-slate-900 mb-1">Doc Interpret</h2>
            <p class="text-slate-400 text-xs font-medium mb-6">Gestão inteligente de exames.</p>
            
            <div id="login-form" class="space-y-3 text-left">
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest ml-1">E-mail</label>
                    <input type="email" id="email" class="w-full p-3.5 bg-slate-50 border border-slate-100 rounded-xl outline-none focus:bg-white focus:border-blue-500/30 transition-all text-sm font-medium" placeholder="nome@email.com">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest ml-1">Senha</label>
                    <input type="password" id="password" class="w-full p-3.5 bg-slate-50 border border-slate-100 rounded-xl outline-none focus:bg-white focus:border-blue-500/30 transition-all text-sm font-medium" placeholder="••••••••">
                </div>
                <button onclick="handleAuth()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg shadow-blue-50 hover:bg-blue-700 active:scale-[0.98] transition-all mt-2">Entrar</button>
                
                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-slate-50"></span></div>
                    <div class="relative flex justify-center text-[9px] uppercase tracking-[0.2em] font-black text-slate-300"><span class="bg-white px-4">ou</span></div>
                </div>

                <button onclick="startQRLoginFlow()" class="w-full bg-white border border-slate-200 text-slate-600 p-3 rounded-xl hover:bg-slate-50 flex items-center justify-center gap-3 transition-all font-bold text-xs">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1-1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                    Acessar via QR Code
                </button>
                
                <div class="pt-4 text-center">
                    <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest cursor-pointer hover:opacity-70 transition-opacity" onclick="toggleAuthMode()" id="toggle-text">Criar nova conta</p>
                </div>
            </div>

            <div id="qr-display-area" class="hidden animate-in fade-in zoom-in duration-300">
                <div id="qrcode" class="bg-white p-4 rounded-[1.5rem] border border-slate-100 inline-block mb-4 shadow-sm"></div>
                <div class="flex items-center justify-center gap-3 text-blue-600 font-bold text-xs">
                    <div class="loader"></div> <span class="tracking-widest uppercase">Sincronizando...</span>
                </div>
                <button onclick="cancelQRLogin()" class="mt-6 text-[10px] font-black text-slate-400 uppercase tracking-widest hover:text-red-500 transition-colors">Voltar</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen pb-20">
        <nav class="glass sticky top-0 z-40 px-6 py-4">
            <div class="max-w-6xl mx-auto flex justify-between items-center relative">
                <div class="flex items-center gap-4">
                    <button onclick="toggleProfileMenu()" class="w-11 h-11 bg-slate-100 rounded-2xl flex items-center justify-center text-slate-500 hover:bg-blue-50 hover:text-blue-600 transition-all border border-transparent hover:border-blue-100">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <button onclick="openScanner()" class="hidden md:flex bg-white border border-slate-200 text-slate-700 px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 items-center gap-2 transition-all shadow-sm active:scale-95">
                        <svg class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812-1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><circle cx="12" cy="13" r="3" /></svg>
                        Conectar Web
                    </button>
                </div>

                <div class="flex items-center gap-3">
                    <span class="text-xl font-black text-slate-900 tracking-tighter hidden sm:block">Doc Interpret</span>
                    <div class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-black shadow-lg shadow-blue-200">D</div>
                </div>

                <div id="profile-menu" class="hidden-scale absolute top-[calc(100%+12px)] left-0 w-72 bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 p-6 z-50 transition-all">
                    <div class="mb-6 pb-6 border-b border-slate-50">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Sua Conta</span>
                        <p class="text-sm font-bold text-slate-900 truncate" id="user-display-name">Carregando...</p>
                    </div>
                    <div class="space-y-1">
                        <button onclick="openPlansModal()" class="w-full flex items-center gap-3 p-4 rounded-2xl hover:bg-slate-50 transition-all text-slate-600 group">
                            <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center group-hover:bg-blue-600 transition-colors">
                                <svg class="w-4 h-4 text-blue-600 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            </div>
                            <span class="text-xs font-bold uppercase tracking-widest">Planos e Upgrade</span>
                        </button>
                        <button onclick="logout()" class="w-full flex items-center gap-3 p-4 rounded-2xl hover:bg-red-50 transition-all text-red-500 group">
                            <div class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center group-hover:bg-red-500 transition-colors">
                                <svg class="w-4 h-4 text-red-500 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            </div>
                            <span class="text-xs font-bold uppercase tracking-widest">Encerrar Sessão</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto p-6 md:p-12">
            <header class="flex flex-col md:flex-row justify-between items-center mb-16 gap-8">
                <div class="text-center md:text-left">
                    <h1 class="text-4xl font-black text-slate-900 tracking-tight mb-2">Meus exames</h1>
                    <p class="text-slate-400 text-base font-medium">Gerencie seu histórico de saúde com IA.</p>
                </div>
                <button onclick="openUploadModal()" class="w-full md:w-auto bg-blue-600 text-white px-10 py-5 rounded-[2.5rem] font-black text-[11px] uppercase tracking-[0.1em] shadow-2xl shadow-blue-200 hover:scale-105 hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center gap-3">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M12 4v16m8-8H4" /></svg>
                    Novo Exame
                </button>
            </header>

            <div id="doc-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                </div>
        </main>
    </div>

    <div id="plans-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md" onclick="closeModal('plans-modal')"></div>
        <div class="bg-white/95 backdrop-blur-2xl w-full max-w-5xl rounded-[3.5rem] p-8 md:p-12 shadow-2xl relative z-10 border border-white/50 overflow-y-auto max-h-[94vh]">
            
            <button onclick="closeModal('plans-modal')" class="absolute top-8 right-8 text-slate-400 hover:text-red-500 transition-colors p-2">
                <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>

            <div id="plans-header" class="text-center mb-12">
                <h3 class="text-4xl font-black tracking-tight mb-4 text-slate-900">Evolua sua saúde</h3>
                <p class="text-slate-500 font-medium">Escolha o plano ideal para suas necessidades.</p>
            </div>

            <div id="period-area" class="flex flex-col items-center mb-12">
                <div id="period-selector" class="switch-toggle" onclick="toggleBilling()">
                    <div class="slider"></div>
                    <span id="label-anual" class="active">Anual <em class="not-italic text-[9px] text-green-600 ml-1">-20%</em></span>
                    <span id="label-mensal">Mensal</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="plans-grid">
                <div class="bg-slate-50 border-2 border-slate-100 rounded-[3rem] p-10 flex flex-col h-full">
                    <h4 class="text-xl font-black mb-1">Iniciante</h4>
                    <div class="flex items-baseline gap-1 mt-4 mb-8">
                        <span class="text-4xl font-black text-slate-900">Grátis</span>
                    </div>
                    <ul class="space-y-4 mb-10 flex-1">
                        <li class="flex items-center gap-3 text-sm font-semibold text-slate-600"><svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg> 2 exames/mês</li>
                        <li class="flex items-center gap-3 text-sm font-semibold text-slate-600"><svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg> Histórico básico</li>
                    </ul>
                    <button id="btn-plan-0" class="w-full py-5 rounded-2xl font-black text-[10px] uppercase tracking-widest bg-slate-200 text-slate-500 cursor-not-allowed">Plano Atual</button>
                </div>

                <div class="bg-blue-50 border-2 border-blue-400/30 rounded-[3rem] p-10 flex flex-col h-full relative shadow-xl shadow-blue-100 scale-105">
                    <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest">Mais Popular</div>
                    <h4 class="text-xl font-black mb-1 text-blue-600">Essencial</h4>
                    <div class="flex items-baseline gap-1 mt-4 mb-8">
                        <span id="price-basic" class="text-5xl font-black text-slate-900 tracking-tighter">R$ 29</span>
                        <span class="text-slate-400 text-xs font-bold uppercase">/mês</span>
                    </div>
                    <ul class="space-y-4 mb-10 flex-1">
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700"><svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg> 10 exames/mês</li>
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-700"><svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg> IA Médica avançada</li>
                    </ul>
                    <button id="btn-plan-1" onclick="handleSubscribe(1)" class="w-full py-5 rounded-2xl font-black text-[10px] uppercase tracking-widest bg-blue-600 text-white shadow-lg hover:bg-blue-700 hover:scale-105 transition-all">Começar agora</button>
                </div>

                <div class="bg-slate-900 border-2 border-slate-900 rounded-[3rem] p-10 flex flex-col h-full shadow-2xl">
                    <h4 class="text-xl font-black mb-1 text-white">Ilimitado</h4>
                    <div class="flex items-baseline gap-1 mt-4 mb-8">
                        <span id="price-pro" class="text-5xl font-black text-white tracking-tighter">R$ 59</span>
                        <span class="text-slate-500 text-xs font-bold uppercase">/mês</span>
                    </div>
                    <ul class="space-y-4 mb-10 flex-1">
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-300"><svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg> Exames ilimitados</li>
                        <li class="flex items-center gap-3 text-sm font-bold text-slate-300"><svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg> Suporte Prioritário</li>
                    </ul>
                    <button id="btn-plan-2" onclick="handleSubscribe(2)" class="w-full py-5 rounded-2xl font-black text-[10px] uppercase tracking-widest bg-white text-slate-900 hover:scale-105 transition-all">Assinar Pro</button>
                </div>
            </div>

            <div id="checkout-container" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-black text-slate-900">Finalizar Assinatura</h3>
                    <p class="text-slate-500 text-sm">Pagamento seguro processado pelo Stripe.</p>
                </div>
                <div id="checkout" class="min-h-[450px]"></div>
                <button onclick="hideCheckout()" class="mt-8 w-full text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 hover:text-red-500 transition-colors">Voltar aos planos</button>
            </div>
        </div>
    </div>

    <div id="upload-modal" class="modal opacity-0 pointer-events-none fixed inset-0 flex items-center justify-center p-4 z-[50]">
        <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-md" onclick="closeModal('upload-modal')"></div>
        <div class="bg-white w-full max-w-lg rounded-[3.5rem] p-10 shadow-2xl relative z-10 border border-slate-100">
            <h3 class="text-2xl font-black mb-8 tracking-tight text-slate-900">Analisar novo laudo</h3>
            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] uppercase font-black text-slate-400 tracking-[0.2em] ml-1">Identificação</label>
                    <input type="text" id="new-doc-name" placeholder="Ex: Hemograma Jan/2026" class="w-full p-4 bg-slate-50 border-2 border-slate-50 rounded-2xl outline-none focus:bg-white focus:border-blue-500/20 text-sm font-bold transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="document.getElementById('file-input-hidden').click()" class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-slate-200 rounded-[2rem] hover:bg-blue-50 transition-all">
                        <svg class="w-7 h-7 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span class="text-[11px] font-bold uppercase text-slate-600 mt-2">Arquivos</span>
                    </button>
                    <button onclick="openInAppCamera()" class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-slate-200 rounded-[2rem] hover:bg-green-50 transition-all">
                        <svg class="w-7 h-7 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812-1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><circle cx="12" cy="13" r="3" /></svg>
                        <span class="text-[11px] font-bold uppercase text-slate-600 mt-2">Câmera</span>
                    </button>
                </div>
                <input type="file" id="file-input-hidden" multiple accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                <div id="preview-area" class="preview-grid hidden max-h-40 overflow-y-auto"></div>
                <div class="flex gap-4 pt-4">
                    <button onclick="closeModal('upload-modal')" class="flex-1 py-5 text-slate-400 font-bold text-xs uppercase tracking-widest">Voltar</button>
                    <button onclick="processDocument()" id="start-ia-btn" class="flex-1 bg-slate-900 text-white py-5 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl disabled:opacity-50">Analisar com IA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/95 backdrop-blur-3xl">
        <div class="w-full max-w-lg h-full flex flex-col p-8">
            <div class="flex justify-between items-center mb-8">
                <span class="text-white text-[10px] font-black uppercase tracking-[0.4em] opacity-60">Escaneamento Médico</span>
                <button onclick="cancelCameraSession()" class="text-white/40 hover:text-red-500 font-bold text-xs tracking-widest transition-colors uppercase">Fechar</button>
            </div>
            <div id="camera-wrapper">
                <video id="camera-video" autoplay playsinline></video>
                <div class="absolute inset-8 border-2 border-white/20 rounded-[2rem] pointer-events-none"></div>
                <canvas id="camera-canvas" class="hidden"></canvas>
            </div>
            <div class="py-12 flex justify-center items-center gap-12">
                <div class="w-12 text-center text-white"><span id="photo-count" class="bg-blue-600 px-3 py-1 rounded-full text-[10px] font-black">0</span></div>
                <button onclick="takeSnapshot()" class="w-24 h-24 bg-white rounded-full border-[6px] border-white/20 flex items-center justify-center">
                    <div class="w-18 h-18 border-4 border-slate-900 rounded-full"></div>
                </button>
                <button onclick="closeCamera()" class="w-12 text-center text-green-400 font-black text-[10px] uppercase tracking-widest">Pronto</button>
            </div>
        </div>
    </div>

    <div id="scanner-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-md" onclick="closeScanner()"></div>
        <div class="bg-white w-full max-w-md rounded-[3rem] overflow-hidden shadow-2xl relative z-10 p-10">
            <button onclick="closeScanner()" class="absolute top-6 right-6 text-slate-400 hover:text-red-500 transition-colors z-20">
                <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="reader" class="rounded-[2.5rem] overflow-hidden bg-slate-100 aspect-square"></div>
            <p class="text-center mt-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">Escaneie o QR Code no Computador</p>
        </div>
    </div>

    <div id="analysis-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[50] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-xl" onclick="closeModal('analysis-modal')"></div>
        <div class="bg-white w-full max-w-3xl rounded-[3rem] shadow-2xl relative z-10 max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-8 bg-slate-50/50 border-b border-slate-100 flex justify-between items-start">
                <div class="flex-1">
                    <h3 id="analysis-title" class="text-2xl font-black text-slate-900 tracking-tight"></h3>
                    <button onclick="copyAnalysisText()" class="mt-2 inline-flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase text-slate-600">Copiar Texto</button>
                </div>
                <button onclick="closeModal('analysis-modal')" class="text-2xl text-slate-400">&times;</button>
            </div>
            <div id="analysis-content" class="p-10 overflow-y-auto"></div>
        </div>
    </div>

    <div id="confirm-delete-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[110] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('confirm-delete-modal')"></div>
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-2xl relative z-10 text-center">
            <h3 class="text-2xl font-black text-slate-900 mb-2">Excluir exame?</h3>
            <div class="flex gap-4 mt-8">
                <button onclick="closeModal('confirm-delete-modal')" class="flex-1 py-5 bg-slate-50 rounded-2xl font-bold text-[11px] uppercase">Manter</button>
                <button id="confirm-delete-btn" class="flex-1 py-5 bg-red-600 text-white rounded-2xl font-bold text-[11px] uppercase">Excluir</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://doc-interpret-926187447831.europe-west1.run.app';
        // Inicialização do Stripe com a sua Public Key
        const stripe = Stripe('pk_test_51SwTKe9JbbIHrSR1EC127ttxDqR0HBkTNR0wuTxWolqvIS3eadY4rPHPfRMi1A4JZHePfgxVoElKS0Iy2yx8hX1200LiqJrUKw');
        
        let token = localStorage.getItem('token');
        let isLogin = true;
        let selectedFiles = [];
        let cameraStream = null;
        let html5QrCode = null;
        let eventSource = null;
        let currentAnalysisRawText = "";
        let pendingDeleteId = null;
        let currentBilling = 'anual'; 
        let checkoutInstance = null; // Instância do embedded checkout

        const loadingPhrases = [
            "Extraindo dados do laudo...",
            "IA interpretando resultados...",
            "Cruzando referências médicas...",
            "Organizando recomendações...",
            "Finalizando relatório..."
        ];

        function notify(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 50);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 3500);
        }

        if (token) showDashboard();

        function toggleAuthMode() {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? 'Doc Interpret' : 'Crie sua conta';
            document.getElementById('toggle-text').innerText = isLogin ? 'Criar nova conta' : 'Já tem uma conta? Entre';
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const endpoint = isLogin ? '/api/auth/login' : '/api/auth/register';
            
            if(!email || !password) return notify('Preencha todos os campos', 'error');
            
            try {
                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    if (data.token) {
                        token = data.token;
                        localStorage.setItem('token', token);
                        localStorage.setItem('userEmail', email);
                        if (!isLogin) notify('Conta criada com sucesso!', 'success');
                        showDashboard();
                    } else {
                        isLogin = true; 
                        toggleAuthMode(); 
                        notify('Conta criada! Por favor, faça login.', 'success');
                    }
                } else {
                    notify(data.error || 'Erro na autenticação', 'error');
                }
            } catch (err) { 
                notify('Erro de conexão com o servidor', 'error'); 
            }
        }

        function startQRLoginFlow() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('qr-display-area').classList.remove('hidden');
            const uuid = crypto.randomUUID();
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: uuid, width: 180, height: 180, colorDark: "#0f172a" });
            if (eventSource) eventSource.close();
            eventSource = new EventSource(`${API_URL}/api/auth/login-qr/stream?uuid=${uuid}`);
            eventSource.addEventListener('login', (e) => {
                const data = JSON.parse(e.data);
                localStorage.setItem('token', data.token);
                localStorage.setItem('userEmail', data.email || 'Usuário');
                location.reload(); 
            });
        }

        function cancelQRLogin() {
            if (eventSource) eventSource.close();
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('qr-display-area').classList.add('hidden');
        }

        function toggleBilling() {
            const toggle = document.getElementById('period-selector');
            currentBilling = currentBilling === 'anual' ? 'mensal' : 'anual';
            toggle.classList.toggle('mensal', currentBilling === 'mensal');
            document.getElementById('price-basic').innerText = currentBilling === 'anual' ? 'R$ 29' : 'R$ 39';
            document.getElementById('price-pro').innerText = currentBilling === 'anual' ? 'R$ 59' : 'R$ 79';
        }

        // Carrega planos e verifica o estado atual do usuário
        async function openPlansModal() {
            hideCheckout(); // Garante que volta para a lista de planos
            try {
                const res = await fetch(`${API_URL}/api/subscription`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                
                if (res.status === 403) {
                    return notify(data.error || 'Verifique sua conta primeiro.', 'error');
                }

                const currentRank = data.subscription_plan || 0;
                [0, 1, 2].forEach(lvl => {
                    const btn = document.getElementById(`btn-plan-${lvl}`);
                    if (!btn) return;
                    if (lvl === currentRank) {
                        btn.disabled = true;
                        btn.innerText = "Plano Atual";
                        btn.className = "w-full py-5 rounded-2xl font-black text-[10px] uppercase bg-slate-100 text-slate-400 cursor-default";
                    } else {
                        btn.disabled = false;
                        btn.innerText = lvl === 2 ? "Assinar Pro" : (lvl === 0 ? "Selecionar" : "Começar agora");
                        btn.className = lvl === 2 ? "w-full py-5 rounded-2xl font-black text-[10px] uppercase bg-white text-slate-900 hover:scale-105 transition-all" : "w-full py-5 rounded-2xl font-black text-[10px] uppercase bg-blue-600 text-white shadow-lg hover:bg-blue-700 hover:scale-105 transition-all";
                    }
                });
                openModal('plans-modal');
            } catch (err) { notify('Erro ao carregar planos', 'error'); }
        }

        // --- Lógica de Checkout Stripe ---

        async function handleSubscribe(planId) {
            const interval = currentBilling === 'anual' ? 'year' : 'month';
            const btn = document.getElementById(`btn-plan-${planId}`);
            const originalText = btn.innerText;

            btn.disabled = true;
            btn.innerText = "Processando...";

            try {
                const res = await fetch(`${API_URL}/api/subscription/subscribe`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        plan: parseInt(planId), 
                        interval: interval 
                    })
                });

                const data = await res.json();

                if (!res.ok) throw new Error(data.error || 'Erro na requisição');

                // Se retornar um clientSecret, abre o checkout
                if (data.clientSecret) {
                    initStripeCheckout(data.clientSecret);
                } else if (data.subscription_plan) {
                    // Upgrade direto sem novo checkout
                    notify(data.message, 'success');
                    openPlansModal();
                }

            } catch (err) {
                notify(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function initStripeCheckout(clientSecret) {
            // Esconde lista e mostra container de checkout
            document.getElementById('plans-grid').classList.add('hidden');
            document.getElementById('plans-header').classList.add('hidden');
            document.getElementById('period-area').classList.add('hidden');
            document.getElementById('checkout-container').classList.remove('hidden');

            // Limpa o container antes de montar
            const checkoutDiv = document.getElementById('checkout');
            checkoutDiv.innerHTML = "";

            if (checkoutInstance) {
                checkoutInstance.destroy();
            }

            try {
                checkoutInstance = await stripe.initEmbeddedCheckout({ clientSecret });
                checkoutInstance.mount('#checkout');
            } catch (e) {
                notify("Erro ao inicializar checkout: " + e.message, "error");
                hideCheckout();
            }
        }

        function hideCheckout() {
            document.getElementById('plans-grid').classList.remove('hidden');
            document.getElementById('plans-header').classList.remove('hidden');
            document.getElementById('period-area').classList.remove('hidden');
            document.getElementById('checkout-container').classList.add('hidden');
            
            if (checkoutInstance) {
                checkoutInstance.destroy();
                checkoutInstance = null;
            }
        }

        // --- Fim Checkout Stripe ---

        function showDashboard() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = localStorage.getItem('userEmail') || 'Usuário';
            loadDocuments();
        }

        async function loadDocuments() {
            try {
                const res = await fetch(`${API_URL}/api/documents`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                
                if (res.status === 403) {
                    notify(data.error || 'Verifique sua conta.', 'error');
                    return;
                }

                const list = document.getElementById('doc-list');
                list.innerHTML = data.documentos?.map(doc => renderCardHTML(doc)).join('') || `<div class="col-span-full py-20 text-center text-slate-400">Nenhum exame.</div>`;
                
                data.documentos?.forEach(doc => {
                    if(doc.is_pending_analysis) startPhraseCycle(doc.id);
                });
            } catch (e) { notify('Erro ao carregar documentos', 'error'); }
        }

        function renderCardHTML(doc) {
            const isPending = doc.is_pending_analysis;
            return `
                <div id="doc-${doc.id}" class="glass-card p-8 rounded-[2.5rem] border border-slate-100 group ${isPending ? 'shimmer' : ''}">
                    <div class="flex justify-between items-start mb-6">
                        <div class="p-4 bg-blue-50 rounded-2xl text-blue-600">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        </div>
                        <button onclick="requestDelete('${doc.id}')" class="p-3 bg-slate-50 text-slate-400 rounded-xl hover:text-red-500 transition-all"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    </div>
                    <h4 class="font-black text-slate-900 truncate mb-1 text-lg">${doc.nome || 'Sem Nome'}</h4>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-10">${new Date(doc.created_at).toLocaleDateString()}</p>
                    <div id="btn-container-${doc.id}">
                        ${isPending ? renderPendingState() : `<button onclick="viewAnalysis('${doc.id}')" class="w-full bg-slate-900 text-white py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-600 transition-all shadow-lg active:scale-95">Ver Relatório IA</button>`}
                    </div>
                </div>`;
        }

        function renderPendingState() {
            return `
                <div class="space-y-3">
                    <div class="flex items-center justify-center gap-3 py-4 bg-blue-50/50 text-blue-600 rounded-2xl">
                        <div class="loader"></div>
                        <span class="phrase-text text-[9px] font-black uppercase tracking-widest animate-pulse">Iniciando análise...</span>
                    </div>
                </div>`;
        }

        function startPhraseCycle(docId) {
            const card = document.getElementById(`doc-${docId}`);
            if (!card) return;
            const phraseEl = card.querySelector('.phrase-text');
            let i = 0;
            const interval = setInterval(() => {
                if (!document.getElementById(`doc-${docId}`) || !card.querySelector('.loader')) {
                    clearInterval(interval);
                    return;
                }
                if (phraseEl) phraseEl.innerText = loadingPhrases[i % loadingPhrases.length];
                i++;
            }, 3000);
        }

        async function processDocument() {
            const name = document.getElementById('new-doc-name').value;
            const btn = document.getElementById('start-ia-btn');
            
            if (!name || selectedFiles.length === 0) return notify('Nome e Imagem obrigatórios', 'error');

            btn.disabled = true;
            btn.innerText = "Convertendo...";
            
            try {
                const b64s = await Promise.all(selectedFiles.map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }));

                const response = await fetch(`${API_URL}/api/documents3`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ images: b64s, nome: name })
                });

                if (response.status === 403) {
                    const errorData = await response.json();
                    notify(errorData.error || 'Verifique sua conta.', 'error');
                    btn.disabled = false;
                    return;
                }

                closeModal('upload-modal');
                notify('Processando...', 'info');
                loadDocuments();

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const lines = decoder.decode(value).split('\n');
                    for (const line of lines) { 
                        if (line.startsWith('data:')) { 
                            try {
                                const data = JSON.parse(line.slice(5).trim()); 
                                if (data.status === 'completed') {
                                    notify('Análise concluída!', 'success');
                                    updateCardToFinished(data.document_id);
                                } 
                            } catch(e) {}
                        } 
                    }
                }
            } catch (err) { 
                notify('Erro no envio', 'error'); 
                loadDocuments(); 
            } finally {
                btn.disabled = false;
                btn.innerText = "Analisar com IA";
            }
        }

        function updateCardToFinished(docId) {
            const container = document.getElementById(`btn-container-${docId}`);
            const card = document.getElementById(`doc-${docId}`);
            if (container) {
                card.classList.remove('shimmer');
                container.innerHTML = `<button onclick="viewAnalysis('${docId}')" class="w-full bg-slate-900 text-white py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-600 transition-all shadow-lg scale-90">Ver Relatório IA</button>`;
            } else {
                loadDocuments();
            }
        }

        async function openInAppCamera() {
            openModal('camera-modal');
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('camera-video').srcObject = cameraStream;
            } catch (err) { closeCamera(); }
        }

        function takeSnapshot() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            canvas.toBlob((blob) => {
                selectedFiles.push(new File([blob], `scan_${Date.now()}.jpg`, { type: 'image/jpeg' }));
                document.getElementById('photo-count').innerText = selectedFiles.length;
                renderPreviews();
            }, 'image/jpeg', 0.85);
        }

        function cancelCameraSession() { closeCamera(); }
        function closeCamera() { if (cameraStream) cameraStream.getTracks().forEach(t => t.stop()); closeModal('camera-modal'); }
        
        function handleFileSelect(e) { 
            const files = Array.from(e.target.files);
            files.forEach(f => selectedFiles.push(f)); 
            renderPreviews(); 
            e.target.value = ""; 
        }

        function renderPreviews() {
            const area = document.getElementById('preview-area');
            if (selectedFiles.length === 0) { area.classList.add('hidden'); return; }
            area.classList.remove('hidden'); area.innerHTML = "";
            selectedFiles.forEach((file, index) => {
                const rd = new FileReader();
                const div = document.createElement('div');
                div.className = "preview-item";
                rd.onload = (e) => { 
                    div.innerHTML = `<img src="${e.target.result}"><div class="remove-img" onclick="removeImage(${index})">&times;</div>`; 
                };
                rd.readAsDataURL(file);
                area.appendChild(div);
            });
        }

        function removeImage(index) { 
            selectedFiles.splice(index, 1); 
            renderPreviews(); 
            document.getElementById('photo-count').innerText = selectedFiles.length; 
        }

        function openScanner() {
            openModal('scanner-modal');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => { authorizeOtherDevice(txt); closeScanner(); });
        }

        async function authorizeOtherDevice(uuid) {
            const res = await fetch(`${API_URL}/api/auth/login-via-qr`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ uuid }) });
            const data = await res.json();
            notify(data.message || data.error, res.ok ? 'success' : 'error');
        }

        function closeScanner() { if (html5QrCode) html5QrCode.stop().finally(() => closeModal('scanner-modal')); else closeModal('scanner-modal'); }

        async function viewAnalysis(id) {
            const res = await fetch(`${API_URL}/api/documents/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            if (res.status === 403) return notify('Verifique sua conta.', 'error');
            currentAnalysisRawText = data.documento.analise;
            document.getElementById('analysis-title').innerText = data.documento.nome;
            document.getElementById('analysis-content').innerHTML = marked.parse(data.documento.analise);
            openModal('analysis-modal');
        }

        function copyAnalysisText() {
            if (currentAnalysisRawText) navigator.clipboard.writeText(currentAnalysisRawText).then(() => notify('Copiado!', 'success'));
        }

        function requestDelete(id) { pendingDeleteId = id; openModal('confirm-delete-modal'); }
        async function performDelete() {
            closeModal('confirm-delete-modal');
            try {
                const res = await fetch(`${API_URL}/api/documents/${pendingDeleteId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                loadDocuments();
            } catch (err) { notify('Erro ao excluir', 'error'); }
        }
        document.getElementById('confirm-delete-btn').onclick = performDelete;

        function toggleProfileMenu() { document.getElementById('profile-menu').classList.toggle('hidden-scale'); }
        function openUploadModal() { 
            document.getElementById('new-doc-name').value = ''; 
            selectedFiles = []; 
            document.getElementById('photo-count').innerText = 0;
            renderPreviews(); 
            openModal('upload-modal'); 
        }
        function openModal(id) { document.getElementById(id).classList.remove('opacity-0', 'pointer-events-none'); }
        function closeModal(id) { document.getElementById(id).classList.add('opacity-0', 'pointer-events-none'); }
        function logout() { localStorage.clear(); location.reload(); }

        window.onclick = function(e) { if (!e.target.closest('nav')) document.getElementById('profile-menu').classList.add('hidden-scale'); }
    </script>
</body>
</html>