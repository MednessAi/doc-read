<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doc Interpret - QR Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .modal { transition: opacity 0.25s ease; }
        body { background-color: #f3f4f6; }
        #reader { width: 100%; }
    </style>
</head>
<body>

    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center text-blue-600">Login</h2>
            
            <div id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full p-2 border rounded">
                <input type="password" id="password" placeholder="Senha" class="w-full p-2 border rounded">
                <button onclick="handleAuth()" id="btn-auth" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 font-bold">Entrar</button>
                
                <div class="relative flex py-3 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400 text-xs uppercase">ou</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <button onclick="startQRLoginFlow()" class="w-full border border-blue-600 text-blue-600 p-2 rounded hover:bg-blue-50 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                    Login via QR Code
                </button>

                <p class="text-center text-sm cursor-pointer text-gray-500 pt-2" onclick="toggleAuthMode()" id="toggle-text">
                    Não tem conta? Cadastre-se
                </p>
            </div>

            <div id="qr-display-area" class="hidden text-center">
                <p class="text-sm text-gray-600 mb-4">Escaneie este código com um dispositivo já logado</p>
                <div id="qrcode" class="flex justify-center mb-4"></div>
                <p id="qr-status" class="text-xs text-blue-500 animate-pulse">Aguardando conexão...</p>
                <button onclick="cancelQRLogin()" class="mt-4 text-sm text-red-500">Voltar para login comum</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen p-6">
        <header class="max-w-4xl mx-auto flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800">Doc Interpret</h1>
            <div class="flex items-center gap-4">
                <button onclick="openScanner()" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-md text-sm font-medium hover:bg-indigo-200 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                    Conectar Dispositivo
                </button>
                <button onclick="logout()" class="text-red-500 hover:underline">Sair</button>
            </div>
        </header>

        <div class="flex justify-center mb-8 text-center flex-col items-center">
            <button onclick="openUploadModal()" class="bg-green-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-green-700 transition">
                + Processar Novo Documento
            </button>
        </div>

        <div id="doc-list" class="max-w-4xl mx-auto grid gap-4"></div>
    </div>

    <div id="scanner-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center bg-black bg-opacity-80 z-[60]">
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg p-6">
            <h3 class="text-xl font-bold mb-4">Escanear QR Code</h3>
            <div id="reader"></div>
            <button onclick="closeScanner()" class="w-full mt-4 bg-gray-200 p-2 rounded text-gray-700">Cancelar</button>
        </div>
    </div>

    <div id="upload-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
        <div class="bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg p-6">
            <h3 class="text-xl font-bold mb-4">Novo Documento</h3>
            <input type="text" id="new-doc-name" placeholder="Nome do Exame" class="w-full p-2 border rounded mb-4">
            <input type="file" id="file-input" multiple accept="image/*" class="mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal('upload-modal')" class="px-4 py-2">Cancelar</button>
                <button onclick="processDocument()" id="btn-process" class="px-4 py-2 bg-blue-600 text-white rounded">Processar</button>
            </div>
        </div>
    </div>

    <div id="analysis-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
        <div class="bg-white w-11/12 md:max-w-2xl mx-auto rounded shadow-lg p-6 overflow-y-auto max-h-[80vh]">
            <h3 id="analysis-title" class="text-xl font-bold mb-4 border-b pb-2"></h3>
            <div id="analysis-content" class="whitespace-pre-wrap text-sm text-gray-700"></div>
            <button onclick="closeModal('analysis-modal')" class="mt-4 w-full bg-gray-100 py-2 rounded">Fechar</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://doc-interpret-926187447831.europe-west1.run.app';
        let token = localStorage.getItem('token');
        let eventSource = null;
        let html5QrCode = null;

        if (token) showDashboard();

        // --- FLUXO DISPOSITIVO DESLOGADO (GERAR QR) ---
        function startQRLoginFlow() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('qr-display-area').classList.remove('hidden');
            
            const uuid = crypto.randomUUID();
            
            // Limpa QR anterior e gera novo
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: uuid,
                width: 200,
                height: 200
            });

            // Abre conexão SSE
            if (eventSource) eventSource.close();
            eventSource = new EventSource(`${API_URL}/api/auth/login-qr/stream?uuid=${uuid}`);

            eventSource.addEventListener('connected', (e) => {
                document.getElementById('qr-status').innerText = JSON.parse(e.data).message;
            });

            eventSource.addEventListener('login', (e) => {
                const data = JSON.parse(e.data);
                token = data.token;
                localStorage.setItem('token', token);
                eventSource.close();
                showDashboard();
                location.reload(); 
            });

            eventSource.addEventListener('timeout', (e) => {
                alert(JSON.parse(e.data).error);
                cancelQRLogin();
            });

            eventSource.onerror = () => {
                console.error("Erro no SSE");
                eventSource.close();
            };
        }

        function cancelQRLogin() {
            if (eventSource) eventSource.close();
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('qr-display-area').classList.add('hidden');
        }

        // --- FLUXO DISPOSITIVO LOGADO (ESCANEAR QR) ---
        function openScanner() {
            const modal = document.getElementById('scanner-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    // QR Lido com sucesso
                    authorizeOtherDevice(decodedText);
                    closeScanner();
                },
                (errorMessage) => { /* scanning... */ }
            ).catch(err => alert("Erro ao acessar câmera: " + err));
        }

        async function authorizeOtherDevice(uuid) {
            try {
                const res = await fetch(`${API_URL}/api/auth/login-via-qr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ uuid })
                });
                const data = await res.json();
                alert(data.message || data.error);
            } catch (err) { alert("Erro na autorização: " + err.message); }
        }

        function closeScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-modal').classList.add('opacity-0', 'pointer-events-none');
                });
            } else {
                document.getElementById('scanner-modal').classList.add('opacity-0', 'pointer-events-none');
            }
        }

        // --- FUNÇÕES BÁSICAS DO SISTEMA (LOGIN, LISTAGEM, ETC) ---
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const endpoint = isLogin ? '/api/auth/login' : '/api/auth/register';
            try {
                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (res.ok && isLogin) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    showDashboard();
                } else if (res.ok) {
                    alert('Cadastrado! Faça login.');
                    toggleAuthMode();
                } else { alert(data.error); }
            } catch (err) { alert('Erro: ' + err.message); }
        }

        let isLogin = true;
        function toggleAuthMode() {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? 'Login' : 'Cadastro';
            document.getElementById('btn-auth').innerText = isLogin ? 'Entrar' : 'Cadastrar';
        }

        function showDashboard() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadDocuments();
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        async function loadDocuments() {
            const res = await fetch(`${API_URL}/api/documents`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            const list = document.getElementById('doc-list');
            list.innerHTML = data.documentos?.map(doc => `
                <div class="bg-white p-4 rounded shadow flex justify-between items-center">
                    <div><h4 class="font-bold">${doc.nome}</h4><p class="text-xs text-gray-400">${new Date(doc.created_at).toLocaleDateString()}</p></div>
                    <div class="flex gap-2">
                        <button onclick="viewAnalysis('${doc.id}')" class="text-blue-600 bg-blue-50 px-2 py-1 rounded text-xs">Análise</button>
                        <button onclick="deleteDoc('${doc.id}')" class="text-red-600 bg-red-50 px-2 py-1 rounded text-xs">Excluir</button>
                    </div>
                </div>
            `).join('') || '';
        }

        async function viewAnalysis(id) {
            const res = await fetch(`${API_URL}/api/documents/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            document.getElementById('analysis-title').innerText = data.documento.nome;
            document.getElementById('analysis-content').innerText = data.documento.analise;
            openModal('analysis-modal');
        }

        async function deleteDoc(id) {
            if (confirm('Deletar?')) {
                await fetch(`${API_URL}/api/documents/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                loadDocuments();
            }
        }

        async function processDocument() {
            const btn = document.getElementById('btn-process');
            btn.innerText = "Processando..."; btn.disabled = true;
            const files = document.getElementById('file-input').files;
            const base64Images = [];
            for (let f of files) {
                const reader = new FileReader();
                const b64 = await new Promise(r => { reader.onload = () => r(reader.result); reader.readAsDataURL(f); });
                base64Images.push(b64.split(',')[1]);
            }
            await fetch(`${API_URL}/api/documents`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ nome: document.getElementById('new-doc-name').value, images: base64Images })
            });
            btn.innerText = "Processar"; btn.disabled = false;
            closeModal('upload-modal'); loadDocuments();
        }

        function openUploadModal() { openModal('upload-modal'); }
        function openModal(id) { document.getElementById(id).classList.remove('opacity-0', 'pointer-events-none'); }
        function closeModal(id) { document.getElementById(id).classList.add('opacity-0', 'pointer-events-none'); }
    </script>
</body>
</html>
